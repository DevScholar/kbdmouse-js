<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mouse Demo - Drag Emulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .demo-area {
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .draggable {
            width: 100px;
            height: 100px;
            background-color: #4CAF50;
            border-radius: 8px;
            position: absolute;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .draggable:hover {
            background-color: #45a049;
        }
        
        .draggable.dragging {
            background-color: #ff9800;
            z-index: 1000;
        }
        
        .controls {
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        
        .control-group input[type="text"] {
            width: 300px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .control-group button {
            padding: 8px 16px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: white;
            color: black;
            border: 2px solid #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .btn-secondary:hover {
            background-color: #f8f9fa;
            border-color: #000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .log-container {
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 20px;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .log-content {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
        }
        
        .log-entry {
            color: #333;
        }
        
        /* Context menu styles */
        .context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 5px 0;
            min-width: 120px;
            z-index: 10000;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .context-menu-item:hover {
            background-color: #f0f0f0;
        }
        
        .context-menu-item.danger {
            color: #dc3545;
        }
        
        .context-menu-separator {
            height: 1px;
            background-color: #e0e0e0;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mouse Demo - Drag Emulation</h1>
        <p>This demo emulates mouse-based dragging without touch events, with optional mouse polyfill for touch devices.</p>
        
        <div class="controls">

            
            <div class="control-group">
                <label>Mouse Polyfill:</label>
                <button id="togglePolyfill" class="btn-primary">Enable Polyfill</button>
                <button id="clearLog" class="btn-secondary">Clear Log</button>
            </div>
            
            <div class="control-group">
                <label>Log Event Types:</label>
                <label><input type="checkbox" id="logMouseEvents" checked> Mouse Events</label>
                <label><input type="checkbox" id="logTouchEvents" checked> Touch Events</label>
                <label><input type="checkbox" id="logPointerEvents" checked> Pointer Events</label>
                <button id="updateLogTypes" class="btn-secondary">Update Types</button>
            </div>
            
            <div class="control-group">
                <label>Demo Controls:</label>
                <button id="addDraggable" class="btn-success">Add Draggable</button>
                <button id="clearDraggables" class="btn-danger">Clear All</button>
            </div>
            
            <div class="control-group">
                <label>Testing:</label>
                <button id="testVibration" class="btn-secondary">Test Vibration</button>
                <button id="toggleVibrate" class="btn-secondary">Disable Vibration</button>
            </div>
        </div>
        
        <div class="demo-area" id="demoArea">
            <div class="draggable" style="left: 50px; top: 50px;">Drag Me!</div>
        </div>
        
        <div class="log-container">
            <div class="log-header">
                <h3>Event Log (Max 100 entries)</h3>
                <span id="logCount">0/100</span>
            </div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <button class="context-menu-item" id="menuAddDraggable">Add Draggable</button>
        <button class="context-menu-item" id="menuClearDraggables">Clear All Draggables</button>
        <div class="context-menu-separator"></div>
        <button class="context-menu-item" id="menuTogglePolyfill">Enable Polyfill</button>
        <button class="context-menu-item" id="menuClearLog">Clear Log</button>
        <div class="context-menu-separator"></div>
        <button class="context-menu-item danger" id="menuResetDemo">Reset Demo</button>
    </div>

    <script type="module">
        // Import mouse polyfill
        import { MousePolyfill } from './mouse-polyfill.js';
        
        // Simple log container class
        class LogContainer {
            constructor() {
                this.logContent = document.getElementById('logContent');
                this.logCount = document.getElementById('logCount');
                this.bindClearButton();
            }
            
            bindClearButton() {
                const clearBtn = document.getElementById('clearLog');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearLog());
                }
            }
            
            addLog(message) {
                // Keep only the last 100 entries
                const entries = this.logContent.children;
                if (entries.length >= 100) {
                    entries[0].remove();
                }
                
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.textContent = message;
                this.logContent.appendChild(div);
                this.logContent.scrollTop = this.logContent.scrollHeight;
                this.logCount.textContent = `${entries.length + 1}/100`;
            }
            
            clearLog() {
                this.logContent.innerHTML = '';
                this.logCount.textContent = '0/100';
            }
        }
        
        class MouseDemo {
            constructor() {
                // Create mouse polyfill instance
                this.mousePolyfill = new MousePolyfill();
                
                // Enable debug logging for demo
                if (this.mousePolyfill.debug) {
                    this.mousePolyfill.debug.enabled = true;
                }
                
                this.polyfillEnabled = false;
                this.vibrateEnabled = true;
                this.draggedElement = null;
                this.dragOffset = { x: 0, y: 0 };
                this.isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                
                this.initializeElements();
                this.setupEventListeners();
                this.updatePolyfillButtonState();
                this.updateVibrateButtonState();
            }
            
            initializeElements() {
                this.demoArea = document.getElementById('demoArea');
                this.togglePolyfillBtn = document.getElementById('togglePolyfill');
            this.clearLogBtn = document.getElementById('clearLog');
            this.addDraggableBtn = document.getElementById('addDraggable');
            this.clearDraggablesBtn = document.getElementById('clearDraggables');
            this.testVibrationBtn = document.getElementById('testVibration');
            this.toggleVibrateBtn = document.getElementById('toggleVibrate');
            this.updateLogTypesBtn = document.getElementById('updateLogTypes');
            this.logMouseEventsCheckbox = document.getElementById('logMouseEvents');
            this.logTouchEventsCheckbox = document.getElementById('logTouchEvents');
            this.logPointerEventsCheckbox = document.getElementById('logPointerEvents');
                this.contextMenu = document.getElementById('contextMenu');
                this.menuAddDraggable = document.getElementById('menuAddDraggable');
                this.menuClearDraggables = document.getElementById('menuClearDraggables');
                this.menuTogglePolyfill = document.getElementById('menuTogglePolyfill');
                this.menuClearLog = document.getElementById('menuClearLog');
                this.menuResetDemo = document.getElementById('menuResetDemo');
            }
            
            setupEventListeners() {
                // Demo area mouse events
                this.demoArea.addEventListener('mousedown', this.handleMouseDown.bind(this));
                this.demoArea.addEventListener('mousemove', this.handleMouseMove.bind(this));
                this.demoArea.addEventListener('mouseup', this.handleMouseUp.bind(this));
                this.demoArea.addEventListener('mouseenter', this.handleMouseEnter.bind(this));
                this.demoArea.addEventListener('mouseleave', this.handleMouseLeave.bind(this));
                this.demoArea.addEventListener('mouseover', this.handleMouseOver.bind(this));
                this.demoArea.addEventListener('mouseout', this.handleMouseOut.bind(this));
                this.demoArea.addEventListener('click', this.handleClick.bind(this));
                this.demoArea.addEventListener('dblclick', this.handleDoubleClick.bind(this));
                this.demoArea.addEventListener('contextmenu', this.handleContextMenu.bind(this));
                
                // Demo area touch events (for polyfill testing)
                this.demoArea.addEventListener('touchstart', this.handleTouchStart.bind(this));
                this.demoArea.addEventListener('touchmove', this.handleTouchMove.bind(this));
                this.demoArea.addEventListener('touchend', this.handleTouchEnd.bind(this));
                this.demoArea.addEventListener('touchcancel', this.handleTouchCancel.bind(this));
                
                // Control buttons
                this.togglePolyfillBtn.addEventListener('click', this.togglePolyfill.bind(this));
                this.addDraggableBtn.addEventListener('click', this.addDraggable.bind(this));
                this.clearDraggablesBtn.addEventListener('click', this.clearDraggables.bind(this));
                this.toggleVibrateBtn.addEventListener('click', this.toggleVibrate.bind(this));
                
                // Test controls
                this.testVibrationBtn.addEventListener('click', this.testVibration.bind(this));
                
                // Log controls
                this.clearLogBtn.addEventListener('click', this.clearLog.bind(this));
                this.updateLogTypesBtn.addEventListener('click', this.updateLogEventTypes.bind(this));
                
                // Context menu events
                document.addEventListener('click', this.hideContextMenu.bind(this));
                this.contextMenu.addEventListener('click', this.handleContextMenuClick.bind(this));
                
                // Global mouse handlers for dragging
                document.addEventListener('mousemove', this.handleGlobalMouseMove.bind(this));
                document.addEventListener('mouseup', this.handleGlobalMouseUp.bind(this));
            }
            
            // Mouse event handlers
            handleMouseDown(event) {
                // Mouse event handled by mousePolyfill debug logging
                if (event.target.classList.contains('draggable')) {
                    this.startDrag(event.target, event.clientX, event.clientY);
                }
            }
            
            handleMouseMove(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleMouseUp(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleMouseEnter(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleMouseLeave(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleMouseOver(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleMouseOut(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleClick(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleDoubleClick(event) {
                // Mouse event handled by mousePolyfill debug logging
            }
            
            handleContextMenu(event) {
                event.preventDefault();
                // Show custom context menu
                this.showContextMenu(event.clientX, event.clientY);
            }
            
            // Touch event handlers
            handleTouchStart(event) {
                // Touch event handled by mousePolyfill debug logging
            }
            
            handleTouchMove(event) {
                // Touch event handled by mousePolyfill debug logging
            }
            
            handleTouchEnd(event) {
                // Touch event handled by mousePolyfill debug logging
            }
            
            handleTouchCancel(event) {
                // Touch event handled by mousePolyfill debug logging
            }
            
            // Wheel event handler
            handleWheel(event) {
                event.preventDefault();
            }
            
            // Global mouse handlers for dragging
            handleGlobalMouseMove(event) {
                if (this.draggedElement) {
                    this.updateDrag(event.clientX, event.clientY);
                }
            }
            
            handleGlobalMouseUp(event) {
                if (this.draggedElement) {
                    this.endDrag();
                }
            }
            
            startDrag(element, clientX, clientY) {
                this.draggedElement = element;
                this.draggedElement.classList.add('dragging');
                
                const rect = this.draggedElement.getBoundingClientRect();
                this.dragOffset.x = clientX - rect.left;
                this.dragOffset.y = clientY - rect.top;
            }
            
            endDrag() {
                if (this.draggedElement) {
                    this.draggedElement.classList.remove('dragging');
                    this.draggedElement = null;
                }
            }
            
            updateDrag(clientX, clientY) {
                if (!this.draggedElement) return;
                
                const demoRect = this.demoArea.getBoundingClientRect();
                let x = clientX - demoRect.left - this.dragOffset.x;
                let y = clientY - demoRect.top - this.dragOffset.y;
                
                // Keep within bounds using modern Math.clamp (polyfilled if not available)
                const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
                x = clamp(x, 0, demoRect.width - this.draggedElement.offsetWidth);
                y = clamp(y, 0, demoRect.height - this.draggedElement.offsetHeight);
                
                this.draggedElement.style.left = `${x}px`;
                this.draggedElement.style.top = `${y}px`;
            }
            
            // Simple logging methods
            addLogEntry(eventType, message) {
                if (window.logContainer) {
                    window.logContainer.addLog(message);
                }
            }
            
            clearLog() {
                if (window.logContainer) {
                    window.logContainer.clearLog();
                }
            }
            
            // Update log event types
            updateLogEventTypes() {
                if (!this.mousePolyfill) return;
                
                const eventTypes = [];
                
                if (document.getElementById('logMouseEvents').checked) {
                    eventTypes.push('mousedown', 'mouseup', 'mousemove', 'mouseenter', 'mouseleave', 'click');
                }
                
                if (document.getElementById('logTouchEvents').checked) {
                    eventTypes.push('touchstart', 'touchend', 'touchmove', 'touchcancel');
                }
                
                if (document.getElementById('logPointerEvents').checked) {
                    eventTypes.push('pointerdown', 'pointerup', 'pointermove', 'pointerenter', 'pointerleave', 'pointercancel');
                }
                
                if (this.mousePolyfill.setLogEventTypes) {
                    this.mousePolyfill.setLogEventTypes(eventTypes);
                    this.addLogEntry('system', `Event types updated: ${eventTypes.join(', ')}`);
                }
            }
            

            
            // Polyfill functionality
            togglePolyfill() {
                this.polyfillEnabled = !this.polyfillEnabled;
                
                if (this.polyfillEnabled) {
                    this.mousePolyfill.addPolyfillFor(this.demoArea);
                    this.updateLogEventTypes(); // Set initial event types
                    this.mousePolyfill.enableMouseLogListener(this.demoArea);
                    this.togglePolyfillBtn.textContent = 'Disable Polyfill';
                } else {
                    this.mousePolyfill.removePolyfillFor(this.demoArea);
                    this.mousePolyfill.disableMouseLogListener(this.demoArea);
                    this.togglePolyfillBtn.textContent = 'Enable Polyfill';
                }
            }
            
            // Update polyfill button state
            updatePolyfillButtonState() {
                // Allow polyfill on all devices for debugging purposes
                this.togglePolyfillBtn.disabled = false;
                this.togglePolyfillBtn.title = '';
                this.togglePolyfillBtn.style.cursor = 'pointer';
            }


            
            // Vibration control
            toggleVibrate() {
                this.vibrateEnabled = !this.vibrateEnabled;
                
                // Set mouse polyfill vibration state
                this.mousePolyfill.vibrate = this.vibrateEnabled;
                
                if (this.vibrateEnabled) {
                    this.toggleVibrateBtn.textContent = 'Disable Vibration';
                } else {
                    this.toggleVibrateBtn.textContent = 'Enable Vibration';
                }
            }
            
            // Update vibration button state
            updateVibrateButtonState() {
                if (this.vibrateEnabled) {
                    this.toggleVibrateBtn.textContent = 'Disable Vibration';
                } else {
                    this.toggleVibrateBtn.textContent = 'Enable Vibration';
                }
            }
            
            // Draggable management
            addDraggable() {
                const draggable = document.createElement('div');
                draggable.className = 'draggable';
                draggable.textContent = 'Drag Me!';
                
                // Random position within demo area using destructuring
                const { width, height } = this.demoArea.getBoundingClientRect();
                const maxX = width - 100;
                const maxY = height - 100;
                
                draggable.style.left = `${Math.random() * maxX}px`;
                draggable.style.top = `${Math.random() * maxY}px`;
                
                this.demoArea.appendChild(draggable);
                // Removed system log - adding draggable is a system event, not a mouse/touch event
                // this.logEvent('add-draggable', { count: this.demoArea.querySelectorAll('.draggable').length });
            }
            
            clearDraggables() {
                const draggables = this.demoArea.querySelectorAll('.draggable');
                draggables.forEach(draggable => draggable.remove());
                // Removed system log - clearing draggables is a system event, not a mouse/touch event
                // this.logEvent('clear-draggables', { count: 0 });
            }
            
            // Context menu functionality
            showContextMenu(clientX, clientY) {
                this.contextMenu.style.left = clientX + 'px';
                this.contextMenu.style.top = clientY + 'px';
                this.contextMenu.style.display = 'block';
                
                // Update menu item text based on current state
                this.menuTogglePolyfill.textContent = this.polyfillEnabled ? 'Disable Polyfill' : 'Enable Polyfill';
            }
            
            hideContextMenu() {
                this.contextMenu.style.display = 'none';
            }
            
            handleContextMenuClick(event) {
                const target = event.target;
                
                if (target === this.menuAddDraggable) {
                    this.addDraggable();
                } else if (target === this.menuClearDraggables) {
                    this.clearDraggables();
                } else if (target === this.menuTogglePolyfill) {
                    this.togglePolyfill();
                } else if (target === this.menuClearLog) {
                    this.clearLog();
                } else if (target === this.menuResetDemo) {
                    this.resetDemo();
                }
                
                this.hideContextMenu();
            }
            
            // Reset demo to initial state
            resetDemo() {
                this.clearDraggables();
                this.clearLog();
                this.addDraggable();
                if (this.polyfillEnabled) {
                    this.togglePolyfill();
                }
                if (!this.vibrateEnabled) {
                    this.toggleVibrate();
                }
                this.resetEventFilter();
                // Removed system log - demo reset is a system event, not a mouse/touch event
                // this.logEvent('demo-reset', { message: 'Demo reset to initial state' });
            }
            
            // Test vibration functionality
            testVibration() {
                if ('vibrate' in navigator) {
                    try {
                        navigator.vibrate(200);
                        // Removed system log - vibration test is a system event, not a mouse/touch event
                        // this.logEvent('vibration-test', { duration: 200, success: true });
                    } catch (error) {
                        // Removed system log - vibration test is a system event, not a mouse/touch event
                        // this.logEvent('vibration-test', { error: error.message, success: false });
                    }
                } else {
                    // Removed system log - vibration test is a system event, not a mouse/touch event
                        // this.logEvent('vibration-test', { error: 'Vibration not supported', success: false });
                }
            }
        }
        
        // Initialize the demo when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.logContainer = new LogContainer(); // Make log container globally accessible
            
            console.log('DOM loaded, initializing MouseDemo');
            const demo = new MouseDemo();
            console.log('MouseDemo initialized');
            
            // Setup custom log function for the demo's mouse polyfill instance
            // 默认情况下，日志会输出到控制台 (console.log)
            // 你可以重写日志函数来自定义输出行为，例如：
            // demo.mousePolyfill.debug.setLogFunction((message) => {
            //     // 自定义日志处理逻辑
            //     console.log('自定义日志: ' + message);
            //     // 或者输出到DOM元素
            //     // document.getElementById('myLog').innerHTML += message + '<br>';
            // });
            if (demo.mousePolyfill.debug && demo.mousePolyfill.debug.setLogFunction) {
                demo.mousePolyfill.debug.setLogFunction((message) => {
                    // Add to visual log container
                    if (window.logContainer) {
                        window.logContainer.addLog(message);
                    }
                });
                // Enable debug logging for demo
                demo.mousePolyfill.debug.enabled = true;
            }
            
            // Add welcome log
            setTimeout(() => {
                if (window.logContainer) {
                    window.logContainer.addLog('Mouse demo initialized');
                }
            }, 100);
        });
    </script>
</body>
</html>