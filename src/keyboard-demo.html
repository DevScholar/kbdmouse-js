<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Keyboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .description {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        /* Input area styles */
        .input-section {
            max-width: 800px;
            margin: 0 auto 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
        }

        /* Virtual keyboard container styles */
        .keyboard-container {
            display: flex;
            justify-content: center;
            margin: 30px auto;
            padding: 0 20px;
            box-sizing: border-box;
        }

        prefab-virtual-keyboard {
            display: block;
            margin: 0 auto;
        }

        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        #text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
            box-sizing: border-box; /* Ensure padding doesn't cause width overflow */
        }

        #text-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Active input field styles */
        .input-active {
            border-color: #27ae60 !important;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        /* Log area styles */
        .log-section {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .log-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 500;
        }

        #clear-log {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        #clear-log:hover {
            background: #c0392b;
        }

        .event-log {
            max-height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 15px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Plain text log styles - simplified */

        /* Scrollbar styles */
        .event-log::-webkit-scrollbar {
            width: 8px;
        }

        .event-log::-webkit-scrollbar-track {
            background: #34495e;
        }

        .event-log::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 4px;
        }

        .event-log::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
     
    </style>
    <style>
        /* Desktop responsive styles for small windows */
        @media screen and (max-width: 1200px) {
            .keyboard-container {
                padding: 0 15px;
            }
            
            prefab-virtual-keyboard {
                display: block;
                width: auto !important; /* Use auto width to prevent stretching */
                max-width: 100% !important;
                margin: 0 auto;
            }
        }
        
        /* Mobile responsive styles for virtual keyboard */
        @media screen and (max-width: 768px) {
            /* Container adjustments */
            .demo-container {
                padding: 10px;
            }
            
            .keyboard-container {
                padding: 0 10px;
                margin: 20px auto;
            }
            
            /* Input section adjustments */
            .input-section {
                margin: 0 auto 20px;
                padding: 15px;
            }
            
            /* Keyboard container responsive scaling */
            prefab-virtual-keyboard {
                display: block;
                width: 100% !important;
                max-width: 100vw !important;
                margin: 0 auto;
            }
            
            /* Ensure keyboard content fits within viewport */
            prefab-virtual-keyboard::part(keyboard-container) {
                max-width: 100vw !important;
                transform-origin: top left !important;
            }
            
            /* Scale down keyboard keys on mobile */
            @media screen and (max-width: 480px) {
                prefab-virtual-keyboard {
                    zoom: 0.8 !important; /* Use zoom instead of transform */
                    margin: 0 auto;
                }
            }
            
            @media screen and (max-width: 360px) {
                prefab-virtual-keyboard {
                    zoom: 0.7 !important; /* Use zoom instead of transform */
                    margin: 0 auto;
                }
            }
            
            /* Log section adjustments */
            .log-section {
                margin: 20px auto;
            }
            
            .event-log {
                max-height: 200px;
                font-size: 11px;
            }
        }
        
        /* Ensure proper scaling for very small screens */
        @media screen and (max-width: 320px) {
            prefab-virtual-keyboard {
                transform: scale(0.6) !important;
                transform-origin: top left !important;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>Virtual Keyboard</h1>
        <div class="description">
            This is a pure layout demonstration of the virtual keyboard using prefab-virtual-keyboard element.<br>
        </div>
        
        <!-- Text input area -->
        <div class="input-section">
            <label for="text-input">Text Input Area:</label>
            <textarea id="text-input" placeholder="Enter text here, or click virtual keyboard buttons..." rows="4"></textarea>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                💡 Tip: Click the input field or use mouse to select text area to activate keyboard input
            </div>
        </div>
        
        <!-- Virtual keyboard container -->
        <div class="keyboard-container">
            <!-- Use prefab-virtual-keyboard element to display virtual keyboard -->
            <prefab-virtual-keyboard 
            id="demo-keyboard"
            keyboard-css-src="/qwerty-104-key-keyboard.css" 
            keyboard-html-src="/qwerty-104-key-keyboard.html"
            >
        </prefab-virtual-keyboard>
        </div>
        
        <!-- Event log area -->
        <div class="log-section">
            <div class="log-header">
                <h3>Keyboard Event Log (Max 100 entries)</h3>
                <button id="clear-log">Clear Log</button>
            </div>
            <div id="event-log" class="event-log"></div>
        </div>
    </div>
    
    <script type="module">
        // Import prefab-virtual-keyboard custom element
        import './prefab-virtual-keyboard.js';

        // Keyboard event logging system
        class KeyboardEventLogger {
            constructor() {
                this.logContainer = document.getElementById('event-log');
                this.clearButton = document.getElementById('clear-log');
                this.maxLogEntries = 100;
                this.logEntries = [];
                
                this.initializeEventListeners();
                this.bindClearButton();
            }

            initializeEventListeners() {
                // Listen to all keyboard events uniformly
                window.addEventListener('keydown', (event) => {
                    const source = this.isVirtualKeyboardEvent(event) ? 'virtual' : 'physical';
                    this.logEvent('keydown', source, event);
                });

                window.addEventListener('keyup', (event) => {
                    const source = this.isVirtualKeyboardEvent(event) ? 'virtual' : 'physical';
                    this.logEvent('keyup', source, event);
                });

                // Listen to text input area changes
                const textInput = document.getElementById('text-input');
                if (textInput) {
                    textInput.addEventListener('input', (event) => {
                        this.logInputEvent(event);
                    });
                }
            }

            isVirtualKeyboardEvent(event) {
                // Check virtual keyboard marker on event object first
                if (event.isVirtualKeyboard) {
                    return true;
                }
                
                // Fallback to path checking (compatibility)
                const path = event.composedPath();
                for (let el of path) {
                    if (el && el.tagName) {
                        const tag = el.tagName.toLowerCase();
                        if (tag === 'virtual-key' || tag === 'virtual-keyboard' || tag === 'prefab-virtual-keyboard') {
                            return true;
                        }
                    }
                }
                return false;
            }

            logEvent(type, source, event) {
                const timestamp = new Date().toLocaleTimeString();
                
                let keyInfo = '';
                let codeInfo = '';

                if (source === 'virtual' || source === 'physical') {
                    // Handle all keyboard events uniformly, whether virtual or physical
                    keyInfo = event.key || 'Unknown';
                    codeInfo = event.code || 'unknown';
                }

                // Check virtual keyboard marker
                const isVirtualKeyboard = event.isVirtualKeyboard || false;
                const actualSource = isVirtualKeyboard ? 'virtual' : source;

                // Get standard KeyboardEvent modifier key states
                const modifiers = {
                    ctrl: event.ctrlKey || false,
                    alt: event.altKey || false,
                    shift: event.shiftKey || false,
                    meta: event.metaKey || false,
                    repeat: event.repeat || false,
                    isComposing: event.isComposing || false,
                    location: event.location || 0
                };

                const logEntry = {
                    timestamp,
                    type,
                    source: actualSource,
                    key: keyInfo,
                    code: codeInfo,
                    isVirtualKeyboard: isVirtualKeyboard, // Add marker information
                    modifiers: modifiers, // Add modifier key states
                    fullEvent: event // Complete native event object
                };

                this.addLogEntry(logEntry);
            }

            logInputEvent(event) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp,
                    type: 'input',
                    source: 'text',
                    key: event.data || 'Backspace/Del',
                    code: 'input',
                    fullEvent: event
                };

                this.addLogEntry(logEntry);
            }

            addLogEntry(logEntry) {
                this.logEntries.push(logEntry); // Add to end
                
                // Limit log entries
                if (this.logEntries.length > this.maxLogEntries) {
                    this.logEntries = this.logEntries.slice(-this.maxLogEntries);
                }

                this.renderLog();
            }

            renderLog() {
                // Plain text log format
                const logText = this.logEntries.map(entry => {
                    const typeMarker = entry.type === 'keydown' ? '▼' : '▲';
                    const sourceMarker = entry.source === 'physical' ? '🔧' : 
                                        entry.source === 'virtual' ? '⌨️' : '📝';
                    const virtualMarker = entry.isVirtualKeyboard ? ' (virtual)' : '';
                    
                    // Format modifier keys display
                    let modifierStr = '';
                    if (entry.modifiers) {
                        const activeModifiers = [];
                        if (entry.modifiers.ctrl) activeModifiers.push('Ctrl');
                        if (entry.modifiers.alt) activeModifiers.push('Alt');
                        if (entry.modifiers.shift) activeModifiers.push('Shift');
                        if (entry.modifiers.meta) activeModifiers.push('Meta');
                        
                        if (activeModifiers.length > 0) {
                            modifierStr = ` [${activeModifiers.join('+')}]`;
                        }
                        
                        // Add additional property information using modern JS features
                        modifierStr += entry.modifiers.repeat ? ' (repeat)' : '';
                        modifierStr += entry.modifiers.isComposing ? ' (composing)' : '';
                        
                        const locationNames = ['', 'Left', 'Right', 'Numpad'];
                        const location = entry.modifiers.location ?? 0;
                        if (location !== 0) {
                            modifierStr += ` (${locationNames[location] ?? 'Unknown'})`;
                        }
                    }
                    
                    return `${entry.timestamp} ${typeMarker}${sourceMarker} ${entry.type} ${entry.source} ${entry.key} [${entry.code}]${virtualMarker}${modifierStr}`;
                }).join('\n');
                
                this.logContainer.textContent = logText;
                
                // Auto-scroll to bottom (latest logs)
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
            }

            bindClearButton() {
                this.clearButton.addEventListener('click', () => {
                    this.clearLog();
                });
            }

            clearLog() {
                this.logEntries = [];
                this.renderLog();
                
                // Add clear notification (system log entry)
                const logEntry = {
                    timestamp: new Date().toLocaleTimeString(),
                    type: 'system',
                    source: 'log',
                    key: 'Log cleared',
                    code: 'clear'
                };
                
                this.logEntries.push(logEntry);
                this.renderLog();
            }
        }

        // Input activation manager
        class InputActivationManager {
            constructor() {
                this.textInput = document.getElementById('text-input');
                this.activeClass = 'input-active';
                this.initializeActivation();
            }

            initializeActivation() {
                // Set up focus event listeners for the input field
                this.textInput.addEventListener('focus', () => {
                    this.activateInput(this.textInput);
                });

                this.textInput.addEventListener('blur', () => {
                    this.deactivateInput(this.textInput);
                });

                // Initial state check (focus check on load)
                if (document.activeElement === this.textInput) {
                    this.activateInput(this.textInput);
                }
            }

            activateInput(inputElement) {
                inputElement.classList.add(this.activeClass);
                console.log('Input field activated:', inputElement.id);
            }

            deactivateInput(inputElement) {
                inputElement.classList.remove(this.activeClass);
                console.log('Input field deactivated:', inputElement.id);
            }
        }





        // Initialize keyboard event log system
        document.addEventListener('DOMContentLoaded', () => {
            const logger = new KeyboardEventLogger();
            const inputManager = new InputActivationManager();
            console.log('Keyboard event log system started');
            console.log('Input activation manager started');
            
            // Add welcome log
            setTimeout(() => {
                logger.addLogEntry({
                    timestamp: new Date().toLocaleTimeString(),
                    type: 'system',
                    source: 'log',
                    key: 'Keyboard event listener started',
                    code: 'ready'
                });
            }, 100);
        });
    </script>
    <script defer>
      // Enhanced desktop and mobile keyboard scaling with proper viewport handling
      // Hardcoded natural dimensions for 104-key keyboard based on CSS analysis
      const NATURAL_KEYBOARD_WIDTH = 1050; // px - estimated from key widths and gaps
      const NATURAL_KEYBOARD_HEIGHT = 420; // px - estimated from key heights and rows
      
      function adjustKeyboardForViewport() {
        const kb = document.querySelector('prefab-virtual-keyboard');
        if (!kb) return;
        
        // Get viewport dimensions
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Check if we're on a mobile device
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase());
        
        // Calculate appropriate scale based on viewport size
        let scale = 1;
        let shouldScale = false;
        
        if (isMobile) {
          // Mobile scaling logic
          if (viewportWidth <= 320) {
            scale = 0.6;
            shouldScale = true;
          } else if (viewportWidth <= 360) {
            scale = 0.7;
            shouldScale = true;
          } else if (viewportWidth <= 480) {
            scale = 0.8;
            shouldScale = true;
          } else if (viewportWidth <= 768) {
            scale = 0.9;
            shouldScale = true;
          }
        } else {
          // Desktop scaling logic - only scale DOWN if window is too small
          // Never scale up/stretch when window is larger than natural size
          
          // Check if viewport is smaller than natural keyboard size
          if (viewportWidth < NATURAL_KEYBOARD_WIDTH) {
            scale = Math.min(scale, viewportWidth / NATURAL_KEYBOARD_WIDTH);
            shouldScale = true;
          }
          
          if (viewportHeight < NATURAL_KEYBOARD_HEIGHT + 200) { // 200px for other UI elements
            const heightScale = (viewportHeight - 200) / NATURAL_KEYBOARD_HEIGHT;
            scale = Math.min(scale, heightScale);
            shouldScale = true;
          }
          
          // Don't scale below 0.5 on desktop to maintain usability
          if (shouldScale) {
            scale = Math.max(scale, 0.5);
          }
        }
        
        // Apply scaling through CSS custom property for better performance
        kb.style.setProperty('--viewport-scale', scale);
        
        // Set keyboard dimensions based on natural size vs viewport comparison
        if (shouldScale) {
          // When scaling is needed, use zoom for true layout reflow
          // zoom naturally uses top-left origin and causes actual layout changes
          kb.style.zoom = scale;
          
          // Remove any transform styles to avoid conflicts
          kb.style.transform = '';
          kb.style.transformOrigin = '';
          
          // Set natural dimensions as base size when scaling
          kb.style.width = NATURAL_KEYBOARD_WIDTH + 'px';
          kb.style.height = NATURAL_KEYBOARD_HEIGHT + 'px';
        } else {
          // When no scaling needed (window >= natural size), don't set any dimensions
          // This allows the keyboard to maintain its natural size without stretching
          kb.style.width = '';
          kb.style.height = '';
          
          // Remove zoom when not scaling
          kb.style.zoom = '';
          kb.style.transform = '';
          kb.style.transformOrigin = '';
        }
        
        console.log(`Keyboard viewport adjustment: viewport=${viewportWidth}x${viewportHeight}px, natural=${NATURAL_KEYBOARD_WIDTH}x${NATURAL_KEYBOARD_HEIGHT}px, scale=${scale}, shouldScale=${shouldScale}, mobile=${isMobile}, usingNaturalSize=${!shouldScale}`);
      }
      
      // Apply on load and on resize
      window.addEventListener('load', adjustKeyboardForViewport);
      window.addEventListener('resize', adjustKeyboardForViewport);
    </script>
</body>
</html>