<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Keyboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .description {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        /* Input area styles */
        .input-section {
            max-width: 800px;
            margin: 0 auto 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
        }

        /* Virtual keyboard container styles */
        .keyboard-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px auto;
            padding: 0 20px;
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
            min-height: 400px; /* Ensure enough space for keyboard */
        }

        prefab-virtual-keyboard {
            display: block;
            margin: 0 auto;
            width: 100%;
            max-width: 100%;
            text-align: center; /* Ensure inline content is centered */
        }

        /* Ensure keyboard content is always centered */
        prefab-virtual-keyboard::part(keyboard-container) {
            margin: 0 auto !important;
            display: inline-block !important;
        }

        /* Additional centering for natural size mode */
        prefab-virtual-keyboard[style*="px"] {
            margin: 0 auto !important;
            display: block !important;
        }

        /* Mobile portrait mode - force full width with maximum overrides */
        @media (max-width: 768px) and (orientation: portrait) {
            .keyboard-container {
                width: 100vw !important;
                max-width: 100vw !important;
                margin: 0 !important;
                padding: 0 !important;
                left: 0 !important;
                right: 0 !important;
                position: relative !important;
            }
            
            prefab-virtual-keyboard {
                width: 100vw !important;
                max-width: 100vw !important;
                margin: 0 !important;
                padding: 0 !important;
                left: 0 !important;
                right: 0 !important;
                position: relative !important;
            }
            
            /* ARCHITECTURAL PRINCIPLE: virtual-keyboard maintains natural size, never force dimensions */
            prefab-virtual-keyboard virtual-keyboard {
                /* DO NOT set width/height/margin/padding on internal virtual-keyboard */
                /* Let it maintain its natural 1044x360 size */
                width: auto !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                left: 0 !important;
                right: 0 !important;
            }
            
            /* Removed zoom/transform override to allow mobile scaling */
            
            /* Shadow DOM parts override - only affect prefab, not internal */
            prefab-virtual-keyboard::part(keyboard) {
                width: 100vw !important;
                max-width: 100vw !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Aggressive reset for any potential left margin sources */
            * {
                margin-left: 0 !important;
                padding-left: 0 !important;
                left: 0 !important;
            }
        }

        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        #text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
            box-sizing: border-box; /* Ensure padding doesn't cause width overflow */
        }

        #text-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Active input field styles */
        .input-active {
            border-color: #27ae60 !important;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        /* Log area styles */
        .log-section {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .log-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 500;
        }

        #clear-log {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        #clear-log:hover {
            background: #c0392b;
        }

        .event-log {
            max-height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 15px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Plain text log styles - simplified */



        /* Scrollbar styles */
        .event-log::-webkit-scrollbar {
            width: 8px;
        }

        .event-log::-webkit-scrollbar-track {
            background: #34495e;
        }

        .event-log::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 4px;
        }

        .event-log::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
     
    </style>
    <style>
        /* Desktop responsive styles for small windows */
        @media screen and (max-width: 1200px) {
            .keyboard-container {
                padding: 0 15px;
                width: 100%;
                max-width: 100%;
            }
            
            prefab-virtual-keyboard {
                display: block;
                width: 100% !important; /* Use 100% width to fill container */
                max-width: 100% !important;
                margin: 0 auto;
            }
        }
        
        /* Mobile responsive styles for virtual keyboard */
        @media screen and (max-width: 768px) {
            /* Container adjustments */
            .demo-container {
                padding: 10px;
            }
            
            .keyboard-container {
                padding: 0 5px; /* Reduce padding for more space */
                margin: 20px auto;
                width: 100%;
                max-width: 100vw;
            }
            
            /* Input section adjustments */
            .input-section {
                margin: 0 auto 20px;
                padding: 15px;
            }
            
            /* Keyboard container responsive scaling */
            prefab-virtual-keyboard {
                display: block;
                width: 100% !important;
                max-width: 100vw !important;
                margin: 0 auto;
            }
            
            /* ARCHITECTURAL PRINCIPLE: For mobile, we need the keyboard to fill width
               The internal virtual-keyboard should scale with the container */
            prefab-virtual-keyboard virtual-keyboard {
                width: 100% !important;
                max-width: 100vw !important;
                /* Allow scaling while maintaining aspect ratio */
                transform-origin: top left !important;
            }
            
            /* Ensure keyboard content fits within viewport */
            prefab-virtual-keyboard::part(keyboard-container) {
                max-width: 100vw !important;
                transform-origin: top left !important;
            }
            
            /* Log section adjustments */
            .log-section {
                margin: 20px auto;
            }
            
            .event-log {
                max-height: 200px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>Virtual Keyboard</h1>
        <div class="description">
            This is a pure layout demonstration of the virtual keyboard using prefab-virtual-keyboard element.<br>
        </div>
        
        <!-- Text input area -->
        <div class="input-section">
            <label for="text-input">Text Input Area:</label>
            <textarea id="text-input" placeholder="Enter text here, or click virtual keyboard buttons..." rows="4"></textarea>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                ðŸ’¡ Tip: Click the input field or use mouse to select text area to activate keyboard input
            </div>
        </div>
        

        
        <!-- Virtual keyboard container -->
        <div class="keyboard-container">
            <!-- Use prefab-virtual-keyboard element to display virtual keyboard -->
            <prefab-virtual-keyboard 
            id="demo-keyboard"
            keyboard-css-src="/qwerty-104-key-keyboard.css" 
            keyboard-html-src="/qwerty-104-key-keyboard.html"
            >
        </prefab-virtual-keyboard>
        </div>
        
        <!-- Event log area -->
        <div class="log-section">
            <div class="log-header">
                <h3>Keyboard Event Log (Max 100 entries)</h3>
                <button id="clear-log">Clear Log</button>
            </div>
            <div id="event-log" class="event-log"></div>
        </div>
    </div>
    
    <script type="module">
        // Import prefab-virtual-keyboard custom element
        import './prefab-virtual-keyboard.js';

        // Hardcoded natural dimensions for the QWERTY 104-key keyboard
        const KEYBOARD_NATURAL_WIDTH = 1044; // pixels
        const KEYBOARD_NATURAL_HEIGHT = 360; // pixels

        // Mobile portrait detection function
        function isMobilePortrait() {
            // Check if it's a mobile device in portrait orientation OR small screen
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isPortrait = window.innerHeight > window.innerWidth;
            const isSmallScreen = window.innerWidth <= 768; // Consider small screens as mobile-like
            
            return (isMobile && isPortrait) || isSmallScreen;
        }

        // Override the scaling behavior for demo page
        function setupDemoKeyboardScaling() {
            const keyboard = document.getElementById('demo-keyboard');
            if (!keyboard) return;

            // Store original applyScaling method
            const originalApplyScaling = keyboard.applyScaling;

            // Override applyScaling with demo-specific logic
            keyboard.applyScaling = function() {
                // ARCHITECTURAL PRINCIPLE: prefab-virtual-keyboard should be agnostic
                // It should scale the container without touching the internal virtual-keyboard element
                
                // For mobile portrait mode, ignore all scaling restrictions and use zoom scaling
                if (isMobilePortrait()) {
                    // ARCHITECTURAL PRINCIPLE: For mobile, we need to balance architecture with usability
                    // On small screens, we scale the entire keyboard to fit width while maintaining aspect ratio
                    const container = this.getContainer();
                    if (container) {
                        const keyboardElement = container.querySelector('virtual-keyboard');
                        if (keyboardElement) {
                            // Calculate scale factor to fit width
                            const scaleFactor = window.innerWidth / KEYBOARD_NATURAL_WIDTH;
                            
                            // Apply zoom scaling to container (not the internal element directly)
                            this.style.zoom = scaleFactor;
                            this.style.width = '100%';
                            this.style.maxWidth = '100%';
                            this.style.margin = '0';
                            this.style.padding = '0';
                            
                            // Clear transform styles to avoid conflicts
                            this.style.transform = '';
                            this.style.transformOrigin = '';
                            
                            return;
                        }
                    }
                    
                    // Fallback: Force 100% width for mobile portrait
                    this.style.width = '100vw';
                    this.style.maxWidth = '100vw';
                    this.style.margin = '0';
                    this.style.padding = '0';
                    this.style.zoom = '';
                    this.style.transform = '';
                    this.style.transformOrigin = '';
                    
                    return;
                }

                // For desktop or landscape mode, use the original logic but with natural size comparison
                const container = this.getContainer();
                if (!container || !this.isContentLoaded || this.naturalWidth === 0 || this.naturalHeight === 0) return;

                const keyboardElement = container.querySelector('virtual-keyboard');
                if (!keyboardElement) return;

                // ARCHITECTURAL PRINCIPLE: Reset only container styles, never touch internal virtual-keyboard
                this.style.width = '';
                this.style.maxWidth = '';
                this.style.margin = '';
                this.style.padding = '';
                this.style.transform = '';
                this.style.transformOrigin = '';
                this.style.zoom = '';

                // Check if window is larger than natural keyboard size
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // Demo: Window size check (agnostic scaling)

                // If window is larger than natural size, don't stretch - maintain natural size
                if (windowWidth > KEYBOARD_NATURAL_WIDTH) {
                    // Set the prefab element to natural size (centered by CSS)
                    this.style.width = KEYBOARD_NATURAL_WIDTH + 'px';
                    this.style.maxWidth = KEYBOARD_NATURAL_WIDTH + 'px';
                    this.style.margin = '0 auto';
                    
                    // DO NOT touch the internal virtual-keyboard element
                    return;
                }

                // If window is smaller than natural size, use original scaling logic
                // ARCHITECTURAL PRINCIPLE: Let the original scaling handle container scaling
                // The original method now uses transform on the container, not the internal element
                
                // Clear any forced dimensions before calling original scaling
                this.style.width = '';
                this.style.maxWidth = '';
                this.style.margin = '';
                
                originalApplyScaling.call(this);
            }

            // Initial scaling
            keyboard.applyScaling();

            // Listen for orientation changes on mobile
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    keyboard.applyScaling();
                }, 100); // Small delay to let dimensions settle
            });

            // Listen for window resize
            window.addEventListener('resize', () => {
                keyboard.applyScaling();
            });
        };

        // Simple log container management
        class LogContainer {
            constructor() {
                this.logContainer = document.getElementById('event-log');
                this.clearButton = document.getElementById('clear-log');
                this.bindClearButton();
            }

            bindClearButton() {
                this.clearButton.addEventListener('click', () => {
                    this.clearLog();
                });
            }

            clearLog() {
                this.logContainer.textContent = '';
            }

            addLog(message) {
                const timestamp = new Date().toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                }) + '.' + new Date().getMilliseconds().toString().padStart(3, '0');
                
                const logEntry = `[${timestamp}] ${message}`;
                this.logContainer.textContent += logEntry + '\n';
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
            }
        }

        // Input activation manager
        class InputActivationManager {
            constructor() {
                this.textInput = document.getElementById('text-input');
                this.activeClass = 'input-active';
                this.initializeActivation();
            }

            initializeActivation() {
                // Set up focus event listeners for the input field
                this.textInput.addEventListener('focus', () => {
                    this.activateInput(this.textInput);
                });

                this.textInput.addEventListener('blur', () => {
                    this.deactivateInput(this.textInput);
                });

                // Initial state check (focus check on load)
                if (document.activeElement === this.textInput) {
                    this.activateInput(this.textInput);
                }
            }

            activateInput(inputElement) {
                inputElement.classList.add(this.activeClass);
            }

            deactivateInput(inputElement) {
                inputElement.classList.remove(this.activeClass);
            }
        }





        // Initialize keyboard demo
        document.addEventListener('DOMContentLoaded', () => {
            window.logContainer = new LogContainer(); // Make log container globally accessible
            const inputManager = new InputActivationManager();
            
            // Setup custom demo keyboard scaling after keyboard is loaded
            const keyboard = document.getElementById('demo-keyboard');
            if (keyboard) {
                // Wait for keyboard content to load
                if (keyboard.isContentLoaded) {
                    setupDemoKeyboardScaling();
                } else {
                    keyboard.addEventListener('content-loaded', () => {
                        setupDemoKeyboardScaling();
                    });
                }
                
                // Setup custom log function for virtual keyboard debug logging
                // This connects the prefab keyboard debug to our visual log container
                if (keyboard.debug && keyboard.debug.setLogFunction) {
                    keyboard.debug.setLogFunction((message) => {
                        // Add to visual log container
                        if (window.logContainer) {
                            window.logContainer.addLog(message);
                        }
                    });
                    // Enable debug logging for demo
                    keyboard.debug.enabled = true;
                }
            }
            
            // Add window-level keyboard event listeners for physical keyboard events
            const textInput = document.getElementById('text-input');
            
            function handleKeyboardEvent(event) {
                const source = event.isVirtualKeyboard ? 'virtual' : 'physical';
                const modifiers = [];
                if (event.ctrlKey) modifiers.push('c');
                if (event.altKey) modifiers.push('a');
                if (event.shiftKey) modifiers.push('s');
                if (event.metaKey) modifiers.push('m');
                
                const logMessage = `event=${event.type},key=${event.key},code=${event.code},mod=${modifiers.join('')},source=${source}`;
                if (window.logContainer) {
                    window.logContainer.addLog(logMessage);
                }
            }
            
            // Listen for events on the text input element (will receive virtual keyboard events)
            textInput.addEventListener('keydown', handleKeyboardEvent);
            textInput.addEventListener('keyup', handleKeyboardEvent);
            textInput.addEventListener('keypress', handleKeyboardEvent);
            
            // Also listen on window for physical keyboard events when no element is focused
            window.addEventListener('keydown', handleKeyboardEvent);
            window.addEventListener('keyup', handleKeyboardEvent);
            window.addEventListener('keypress', handleKeyboardEvent);
            
            // Add welcome log
            setTimeout(() => {
                if (window.logContainer) {
                    window.logContainer.addLog('Keyboard demo initialized');
                }
            }, 100);
        });
        
        // Debug function to check current mobile state
        window.debugMobileState = function() {
            const keyboard = document.getElementById('demo-keyboard');
            if (keyboard) {
                // Check inline styles
            }
        };
        

    </script>
</body>
</html>